name: Hourly Data Pipeline with Hopsworks

on:
  schedule:
    - cron: '0 * * * *'  # Run every hour
  workflow_dispatch:      # Allow manual triggering

jobs:
  run-data-pipeline:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9' # Or your preferred version (e.g., 3.10)

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Ensure your requirements.txt includes hopsworks, pandas, dotenv, etc.
          pip install -r requirements.txt
          # Install dependencies for running notebooks
          pip install jupyter papermill ipykernel
          python -m ipykernel install --user --name python3 --display-name "Python 3"
        
      - name: Run feature extraction from API
        run: papermill feature_extract_from_api_hourly.ipynb /tmp/feature_extract_output.ipynb
          
      - name: Run data extraction
        run: papermill extract_data.ipynb /tmp/extract_data_output.ipynb
          
      - name: Run EDA and cleaning
        run: |
          # This step MUST produce the 'cleaned_aqi_weather_dataset.csv' file
          # that your setup_hopsworks.py script expects by default.
          papermill EDA.ipynb /tmp/eda_output.ipynb || echo "EDA notebook completed with potential warnings"
        continue-on-error: true
      
      - name: Ingest data to Hopsworks (REQUIRED)
        env:
          HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}
          HOPSWORKS_PROJECT_NAME: ${{ secrets.HOPSWORKS_PROJECT_NAME }}
        run: |
          echo "Starting data ingestion into Hopsworks..."
          # Your script handles finding the feature group and inserting data when --insert is used
          python setup_hopsworks.py --insert
          
          # Error handling to fail the workflow if ingestion fails
          if [ $? -ne 0 ]; then
            echo "Hopsworks data ingestion FAILED!"
            exit 1
          fi
          echo "Data successfully ingested into Hopsworks."

